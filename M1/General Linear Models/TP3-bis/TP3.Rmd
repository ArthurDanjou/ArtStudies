```{r}
setwd('/Users/arthurdanjou/Workspace/studies/M1/General Linear Models/TP3-bis')

library(GGally)
library(broom)
library(scales)
library(car)
library(glue)
library(janitor)
library(marginaleffects)
library(tidyverse)
library(qqplotr)
options(scipen = 999, digits = 5)
```
```{r}
data03 <- read.csv('data03.csv', header = TRUE, sep = ',', dec = '.')
data03$sexe <- as.factor(data03$sexe)
data03$travail <- as.factor(data03$travail)
head(data03, 15)
```
```{r}
tab_sexe <- data03 |>
  count(sexe) |>
  mutate(freq1 = n / sum(n)) |>
  mutate(freq2 = glue("{n} ({label_percent()(freq1)})")) |>
  rename(Sexe = 1, Effectif = n, Proportion = freq1, "n (%)" = freq2)
tab_sexe
```

```{r}
tab_travail <- data03 |>
  count(travail) |>
  mutate(freq1 = n / sum(n)) |>
  mutate(freq2 = glue("{n} ({label_percent()(freq1)})")) |>
  rename(Travail = 1, Effectif = n, Proportion = freq1, "n (%)" = freq2)
tab_travail
```

```{r}
cross_sexe_travail <- data03 |>
  count(sexe, Travail = travail) |>
  group_by(sexe) |>
  mutate(freq1 = n / sum(n)) |>
  mutate(freq2 = glue("{n} ({label_percent(0.1)(freq1)})"), n = NULL, freq1 = NULL) |>
  pivot_wider(names_from = sexe, values_from = freq2)
cross_sexe_travail
```

```{r}
data03 <- mutate(data03, logy = log(y))

data03 |>
  pivot_longer(c(y, logy), names_to = "variable", values_to = "value") |>
  mutate(variable = factor(
    variable,
    levels = c("y", "logy"),
    labels = c("Salaire", "Log-Salaire"))
  ) |>
  ggplot(aes(x = value)) +
  facet_wrap(vars(variable), scales = "free") +
  geom_histogram(
    fill = "dodgerblue",
    color = "black",
    bins = 15) +
  scale_y_continuous(expand = expansion(c(0, 0.05))) +
  scale_x_continuous(breaks = pretty_breaks()) +
  labs(x = "Valeur", y = "Effectif") +
  theme_bw(base_size = 14) +
  theme(strip.text = element_text(size = 11, face = "bold"))
```
```{r}
data03 |>
  pivot_longer(c(y, logy), names_to = "variable", values_to = "value") |>
  mutate(variable = factor(
    variable,
    levels = c("y", "logy"), labels = c("Salaire", "Log-Salaire")
  )) |>
  ggplot(aes(x = sexe, y = value)) +
  facet_wrap(vars(variable), scales = "free") +
  geom_boxplot(
    width = 0.5, fill = "cyan", linewidth = 0.5, outlier.size = 2, outlier.alpha = 0.3
  ) +
  scale_y_continuous(breaks = pretty_breaks()) +
  labs(x = NULL, y = "Valeur") +
  theme_bw(base_size = 14) +
  theme(
    strip.text = element_text(size = 11, face = "bold"),
    panel.border = element_rect(linewidth = 0.5)
  )
```
```{r}
data03 |>
  pivot_longer(c(y, logy), names_to = "variable", values_to = "value") |>
  mutate(variable = factor(
    variable,
    levels = c("y", "logy"), labels = c("Salaire", "Log-Salaire")
  )) |>
  ggplot(aes(x = travail, y = value)) +
  facet_wrap(vars(variable), scales = "free") +
  stat_boxplot(width = 0.25, geom = "errorbar", linewidth = 0.5) +
  geom_boxplot(
    width = 0.5, fatten = 0.25, fill = "cyan", linewidth = 0.5,
    outlier.size = 2, outlier.alpha = 0.3
  ) +
  scale_y_continuous(breaks = pretty_breaks()) +
  labs(x = NULL, y = "Valeur") +
  theme_bw(base_size = 14) +
  theme(
    strip.text = element_text(size = 11, face = "bold"),
    panel.border = element_rect(linewidth = 0.5)
  )
```

```{r}
data03 |>
  group_by(sexe) |>
  summarise(n = n(), "Mean (Salaire)" = mean(y), "SD (Salaire)" = sd(y))
```

```{r}
data03 |>
  group_by(travail) |>
  summarise(n = n(), "Mean (Salaire)" = mean(y), "SD (Salaire)" = sd(y))
```

```{r}
data03 |>
  group_by(sexe, travail) |>
  summarise(n = n(), "Mean (Salaire)" = mean(y), "SD (Salaire)" = sd(y))
```
```{r}
data03 |>
  group_by(sexe) |>
  summarise(n = n(), "Mean (Salaire)" = mean(logy), "SD (Salaire)" = sd(logy))
```

```{r}
data03 |>
  group_by(travail) |>
  summarise(n = n(), "Mean (Salaire)" = mean(logy), "SD (Salaire)" = sd(logy))
```

```{r}
data03 |>
  group_by(sexe, travail) |>
  summarise(n = n(), "Mean (Salaire)" = mean(logy), "SD (Salaire)" = sd(logy))
```
```{r}
data03 <- data03 |>
  mutate(sexef = ifelse(sexe == "Femme", 1, 0), sexeh = 1 - sexef) |>
  mutate(job1 = (travail == "Type 1") * 1) |>
  mutate(job2 = (travail == "Type 2") * 1) |>
  mutate(job3 = (travail == "Type 3") * 1)
head(data03, 15)
```
```{r}
mod1 <- lm(y ~ sexeh, data = data03)
mod2 <- lm(y ~ job2 + job3, data = data03)
mod3 <- lm(y ~ sexeh + job2 + job3, data = data03)
tidy(mod1)
tidy(mod2)
tidy(mod3)
```

InterprÃ©tations des coefficients du modÃ¨le 1
$ð‘¦_i = Î²_0 + Î²_1 sexeh_i + Ïµ_i$
â€¢ (Intercept): $\hat{Î²_0} = 7.88$ : Salaire moyen chez les femmes
â€¢ sexeh: $\hat{ð›½1} = 2.12$ : Les hommes gagnent en moyenne 2.12 dollars par heure de plus que les femmes
(significatif).

InterprÃ©tations des coefficients du modÃ¨le 2
$ð‘¦_i = Î²_0 + Î²_1 job2_i + Î²_2 job3_i + Ïµ_i$
â€¢ (Intercept): $\hat{Î²_0} = 12.21$ : Salaire moyen pour le travail de type 1.
â€¢ job2: $\hat{Î²_1} = âˆ’5.09$ : la diffÃ©rence de salaire entre le travail de type 2 et celui de type 1 est de âˆ’5.09 dollars par heure en moyenne (significatif)
â€¢ job3: $\hat{Î²_2} = âˆ’3.78$ : la diffÃ©rence de salaire entre le travail de type 3 et celui de type 1 est de âˆ’3.78 dollarspar heure en moyenne (significatif).

InterprÃ©tations des coefficients du modÃ¨le 3
$ð‘¦_i = Î²_0 + Î²_1 sexeh_i + Î²_2 job2_i + Î²_3 job3_i + Ïµ_i$
â€¢ (Intercept): $\hat{Î²_0} = 11.13$ : Salaire moyen chez les femmes avec un travail de type 1
â€¢ sexeh: $\hat{Î²_1 = 1.97$ : Les hommes gagnent en moyenne 1.97 dollars par heure de plus que les femmes
(significatif), quelque soit le type de travail.
â€¢ job2: $\hat{Î²_2} = âˆ’4.71$ : la diffÃ©rence de salaire entre le travail de type 2 et celui de type 1 est de âˆ’4.71 dollars par heure en moyenne (significatif), quelque soit le sexe.
â€¢ job3: $\hat{Î²_3} = âˆ’4.3$ : la diffÃ©rence de salaire entre le travail de type 3 et celui de type 1 est de âˆ’4.3 dollars par heure en moyenne (significatif), quelque soit le sexe.

```{r}
anova(mod1, mod3)
```
La p-value du test est infÃ©rieur Ã  0.05, on rejette donc $ð»0$ et on conclue quâ€™au moins un des coefficients (ð›½1, ð›½2) est significativement non nulle.
â€¢ On vient de tester si le type de travail est associÃ© au salaire horaire. Câ€™est donc le cas pour ces donnÃ©es.
```{r}
linearHypothesis(mod3, c("job2", "job3"))
linearHypothesis(mod3, "job2 = job3")
```
Le test est non significatif (ð‘ = 0.44). On ne rejette pas $ð»0$ et on conclue quâ€™il nâ€™y pas de diffÃ©rence de salaire horaire entre le travail de type 2 et le travail de type 3, quelque soit le sexe.
```{r}
mod3bis <- lm(y ~ sexe + travail, data = data03)
summary(mod3bis)
```
Les modÃ¨les mod3bis1 et mod3 sont identiques
â€¢ Pas besoins de crÃ©er toutes ces variables indicatrices si nos variables catÃ©gorielles sont de type factor !
â€¢ La rÃ©fÃ©rence sera toujours la premiÃ¨re modalitÃ© du factor.
â€¢ On peut changer la rÃ©fÃ©rence avec `relevel()` ou avec `C()`. Par exemple, si on veut la modalitÃ© 2 en rÃ©fÃ©rence pour le travail
```{r}
lm(y ~ sexe + relevel(travail, ref = 2), data = data03) |>
  tidy()
```
